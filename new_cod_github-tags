name: Attach TAgs with each commit



on:

  push:

    branches:

      - master
 
permissions:

  contents: write
 
jobs:

  tag:

    runs-on: ubuntu-latest
 
    steps:

      - name: Checkout repository

        uses: actions/checkout@v3

        with:

          fetch-depth: 0

          tags: true
 
      - name: Set up Git

        run: |

          git config --global user.name "${GITHUB_USER_NAME}"

          git config --global user.email "${GITHUB_USER_EMAIL}"
 
      - name: Fetch tags

        run: git fetch --tags
 
      - name: Get current version

        id: get_version

        run: |

          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          echo "Current version: $VERSION"

          echo "::set-output name=VERSION::$VERSION"
 
      - name: Calculate the next version

        id: increment_version

        run: |

          VERSION=${{ steps.get_version.outputs.VERSION }}

          IFS='.' read -r -a VERSION_PARTS <<< "${VERSION#v}"

          MAJOR=${VERSION_PARTS[0]}

          MINOR=${VERSION_PARTS[1]}

          PATCH=${VERSION_PARTS[2]}

          PATCH=$((PATCH + 1))

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
 
          # Ensure the new version tag is unique

          while git rev-parse "$NEW_VERSION" >/dev/null 2>&1; do

            PATCH=$((PATCH + 1))

            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"

          done
 
          echo "New version: $NEW_VERSION"

          echo "::set-output name=NEW_VERSION::$NEW_VERSION"
 
      - name: Create and push tag

        env:

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: |

          NEW_VERSION=${{ steps.increment_version.outputs.NEW_VERSION }}

          git tag $NEW_VERSION

          git push origin $NEW_VERSION

 
